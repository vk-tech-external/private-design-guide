# {heading(Интеграция с внешними системами)[id=external_integration]}

## {heading(LDAP/Active Directory)[id=integration_ad]}

В рамках интеграции с корпоративным каталогом (AD) {var(sys1)} отсылает информацию о виртуальной машине (далее — ВМ) для обеспечения создания данной ВМ в соответствующем корпоративном каталоге Заказчика.

### {heading(События-триггеры отправки)[id=integration_ad_trigger]}

На информацию, отправляемую о ВМ, оказывают влияние следующие действия пользователей:

* создание / удаление ВМ;
* подключение / отключение сетевого интерфейса;
* изменение приватного DNS имени сетевого интерфейса.

### {heading(Структура передаваемых данных)[id=integration_ad_data_structure]}

* При создании ВМ {var(sys5)} формируется информация о созданной ВМ и отправляется в сторону Интеграционного сервиса, который создаст необходимые записи в корпоративном каталоге.
* При удалении ВМ {var(sys5)} формируется информация об удаленной ВМ и отправляется в сторону Интеграционного сервиса, который удалит необходимые записи в корпоративном каталоге.
* При изменении FQDN {var(sys5)} формируется информация об измененной ВМ и отправляться в сторону Интеграционного сервиса, который выполнит необходимые действия в корпоративном каталоге.

<warn>

Реализация Интеграционного сервиса может быть уникальна для конкретного Заказчика.

</warn>

Структурно информация AD состоит из двух словарей с данными о группе и сервере. В текущей реализации на каждый сервер создается собственная группа в корпоративном каталоге. При этом на стороне Интеграционного сервиса данное поведение может быть изменено соответствующими настройками сервиса.

{caption(Таблица {counter(table)[id=numb_tab_integration_info_group]} — Информация о группе)[align=right;position=above;id=tab_integration_info_group;number={const(numb_tab_integration_info_group)}]}
[cols="1,3"]
|===
|hostname
|FQDN первого сетевого интерфейса ВМ (детали см. в CMDB)

|operating_system
|Рассчитывается маппингом по настроечной таблице исходя из метадаты `os_type` корневого диска

|members
|Список, единственный элемент которого — имя пользователя (из Keystone), создавшего ВМ, с заданным в настройках суффиксом
|===
{/caption}

{caption(Таблица {counter(table)[id=numb_tab_integration_info_server]} — Информация о сервере)[align=right;position=above;id=tab_integration_info_server;number={const(numb_tab_integration_info_server)}]}
[cols="1,3"]
|===
|hostname
|FQDN первого сетевого интерфейса ВМ (детали см. в CMDB)

|operating_system
|Рассчитывается маппингом по настроечной таблице исходя из метадаты os_type корневого диска
|===
{/caption}

Информация AD не отправляется, если:

* ВМ создана под нужды PaaS.
* ВМ принадлежит настраиваемому списку игнорируемых проектов.

## {heading(DNS)[id=integration_dns]}

В рамках интеграции с корпоративной системой DNS {var(sys1)} отсылает информацию о ВМ и балансировщиках нагрузки (далее — LBS) для обеспечения создания А-записей в системе DNS Заказчика.

### {heading(События-триггеры отправки)[id=integration_dns_trigger]}

На информацию, отправляемую о ВМ и LBS, оказывают влияние следующие действия пользователей:

* создание / удаление ВМ;
* подключение / отключение сетевых интерфейсов ВМ;
* изменение DNS имени сетевых интерфейсов ВМ;
* создание / удаление балансировщика;
* изменение DNS имени VIP сетевого интерфейса балансировщика;
* создание / масштабирование / удаление PaaS объектов.

### {heading(Структура передаваемых данных)[id=integration_dns_data_structure]}

* При создании объекта (ВМ, балансировщика) {var(sys5)} формируется информация о созданном объекте и отправляется в сторону Интеграционного сервиса, который создаст необходимые А-записи в корпоративной системе DNS.
* При удалении объекта (ВМ, балансировщика) {var(sys5)} формируется информация об удаленном объекте и отправляется в сторону Интеграционного сервиса, который удалит необходимые А-записи в корпоративной системе DNS.
* При изменении объекта (ВМ, балансировщика) {var(sys5)} формируется информация об измененном объекте и отправляется в сторону Интеграционного сервиса, который изменит необходимые А-записи в корпоративной системе DNS.

<warn>

Реализация Интеграционного сервиса может быть уникальна для конкретного Заказчика.

</warn>

Структурно информация DNS состоит из одного словаря.

{caption(Таблица {counter(table)[id=numb_tab_integration_dns_info]} — Информация DNS)[align=right;position=above;id=tab_integration_dns_info;number={const(numb_tab_integration_dns_info)}]}
[cols="1,3"]
|===
|FQDN
|FQDN сетевого интерфейса объекта (детали см. в CMDB)

|ip
|первый IP-адрес соответствующего сетевого интерфейса
|===
{/caption}

Информация DNS синхронизируется:

* Для всех сетевых интерфейсов ВМ, кроме принадлежащих настраиваемому списку проектов.
* Для балансировщиков LBaaS и Octavia, имеющих DNS-имя VIP сетевых интерфейсов, отличное от стандартного (`host-<ip>`):

   * созданных на фронте;
   * балансировщиков DBaaS;
   * балансировщиков k8s API KaaS.

## {heading(CMDB)[id=integration_cmdb]}

В рамках интеграции с системами CMDB {var(sys1)} отсылает информацию о ВМ, включая информацию о дисках и сетях данной ВМ.

### {heading(События-триггеры отправки)[id=integration_cmdb_trigger]}

На информацию отправляемую о ВМ, оказывают влияние следующие действия пользователей:

* создание / удаление ВМ;
* изменение параметров ВМ;
* включение / выключение ВМ;
* подключение / отключение / замена диска;
* изменение размера диска;
* подключение / отключение сетевого интерфейса ВМ;
* переименование сетевого интерфейса, в том числе приватного DNS-имени;
* создание / изменение / масштабирование / удаление объектов PaaS.

### {heading(Структура передаваемых данных)[id=integration_cmdb_data_structure]}

Информация, передаваемая {var(sys5)} в сторону Интеграционного сервиса, представляет единую структуру данных (словарь), подчиняющуюся следующим принципам:

* При создании ВМ словарь должен отправляться со всеми данными о ВМ.
* При изменениях каких-либо объектов, влияющих на информацию о ВМ, посылаемый словарь может содержать только данные, связанные с изменившимися объектами.
* При удалении ВМ отправляется обновление информации о ВМ с соответствующим статусом.

{caption(Таблица {counter(table)[id=numb_tab_integration_info_vm]} — Информация о ВМ, передаваемая {var(sys5)} в сторону Интеграционного сервиса)[align=right;position=above;id=tab_integration_info_vm;number={const(numb_tab_integration_info_vm)}]}
[cols="1,3"]
|===
|Status
|Рассчитывается маппингом по настроечной таблице исходя из состояния ВМ на гипервизоре (OS-EXT-STS:vm_state) или факта удаленности ВМ

|PlatformID
|Идентификатор ВМ в облаке

|Project
|Заголовок проекта ВМ (из IAM)

|Contact
|Имя пользователя (из Keystone), создавшего ВМ, с заданным в настройках суффиксом

|Cluster
|Availability zone ВМ

|RAM
|Объем оперативной памяти ВМ, округленный до ГБ в меньшую сторону

|CPUCores
|Количество процессоров ВМ

|CPUSockets
|Количество процессоров ВМ

|HDDCurrentValue
|Объем всех дисков, подключенных к ВМ, плюс размер корневого эфемерного диска, если используется

|SoftwareName
|Значение метадаты `os_full_name` корневого диска. В случае её отсутствия — `os_type`. В случае и её отсутствия — значение из настройки. Должно начинаться с заглавной буквы.

|j.network
|Информация о сетевых интерфейсах ВМ. Массив. Описание см. ниже.

|NetworkName
|FQDN первого сетевого интерфейса ВМ без конечной точки

|InstanceType
|Рассчитывается маппингом по настроечной таблице исходя из `provider:segmentation_id` сети первого сетевого интерфейса ВМ

|ManagementIP
|Первый приватный адрес первого сетевого интерфейса ВМ
|===
{/caption}

{caption(Таблица {counter(table)[id=numb_integration_info_network_vm]} — Информация о сетевом интерфейсе ВМ)[align=right;position=above;id=tab_integration_info_network_vm;number={const(numb_tab_integration_info_vm)}]}
[cols="1,3"]
|===
|NetworkInterfaceIP
|Первый IP-адрес интерфейса в приватной сети

|NetworkInterfaceMAC
|MAC-адрес интерфейса

|NetworkInterfaceName
|Имя сетевого интерфейса (имя в OpenStack)

|NetworkInterfaceVLAN
|Рассчитывается как `VLAN_` + `<provider:segmentation_id>`

|NetworkInterfaceMask
|Маска сети
|===
{/caption}

<info>

В таблице под настройками понимаются настройки системы синхронизации, доступные к конфигурированию на этапах развертывания и сопровождения.

</info>

FQDN является строкой в формате:

```txt
<ЗАГОЛОВОК_ПРОЕКТА>-<DNS-ИМЯ_ИНТЕРФЕЙСА>.<DNS-ДОМЕН>.
```

, где:

* Заголовок проекта берется из IAM.
* Длина имени до первой точки обрезается до 15 символов.
* Домен берется из настроек сети сетевого интерфейса.

### {heading(Условия, по которым не выполняется отправка информации)[id=integration_cmdb_conditions]}

Информация о ВМ не отправляется, если:

* У ВМ отсутствуют сетевые интерфейсы.
* ВМ принадлежит настраиваемому списку игнорируемых проектов.

### {heading(Ограничения существующей реализации)[id=integration_cmdb_restrictions]}

Для работы синхронизации CMDB требуется Consul — для синхронизации отправки данных в соответствующий специальный сервис.

В некоторых случаях не достаточно изменить данные, влияющие на информацию для синхронизации, чтобы эти изменения синхронизировались. К таким случаям относятся:

* изменение заголовка проекта в IAM,
* изменение метадаты корневого диска,
* изменение параметров сети.

При недоступности специальных сервисов синхронизации или других проблемах обработки изменений синхронизация может не выполниться.

Балансировщики нагрузки Kubernetes-aaS (Magnum от VK) не получают DNS-имя, поскольку K8s создает VIP сетевой интерфейс со стандартным DNS-именем (`host-<ip>`). В том числе стандартный ингресс контроллер. Поэтому DNS доступа к пользовательским сервисам в Kubernetes нет.

## {heading(Поддерживаемые антивирусы и системы безопасности)[id=integration_cmdb_safety]}

На данный момент список поддерживаемых антивирусных продуктов и средств защиты информации пуст. Каждое требование по интеграции должно быть рассмотрено индивидуально.