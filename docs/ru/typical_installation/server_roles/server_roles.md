# {heading(Роли серверов)[id=server_roles]}

В рамках {var(system)} выделяется несколько ролей серверов, которые несут соответствующие функции. В зависимости от роли отличаются требования к производительности и конфигурации сервера, правила сайзинга.

## {heading(Общие требования к серверному оборудованию)[id=server_requirement]}

Рекомендуется использовать серверы и сетевое оборудование надежных производителей, при этом не существует «белого» или «черного» списка брендов.

### {heading(Процессоры)[id=server_requirement_cpu]}

Рекомендуется использовать серверы с процессорами актуального поколения для ролей с высокой нагрузкой. Допускается использование процессоров как Intel Xeon, так и AMD EPYC.

<err>

В настоящее время поддерживаются только процессоры с архитектурой x86_64 (AMD64).

</err>

### {heading(Виртуальные машины)[id=server_requirement_vm]}

* Для серверов ролей **Deploy** и **Monitoring**/**Logging** возможно использовать как физические, так и виртуальные машины.
* Для роли **RS** допустимо, но не рекомендуется использовать виртуальные машины.

### {heading(RAID-контроллеры)[id=server_requirement_raid]}

Не рекомендуется использовать аппаратные RAID-контроллеры — это правило действительно для всех ролей, включая **СХД**. Причины: более низкая, чем у программных решений скорость на используемых в {var(sys3)} уровнях массивов и более сложное восстановление данных в случае отказа.

Если в рекомендациях по роли не указано иное, для обеспечения оптимальной надежности и производительности рекомендуется использовать массивы следующих уровней:

* Уровень 1: зеркало, два диска.
* Уровень 10: зеркало+чередование, четыре диска.

## {heading(Controlplane)[id=server_requirement_controlplane]}

На серверах этой группы осуществляется работа служб слоя управления {var(sys5)} и программно-определяемой сети. Для этих серверов рекомендуется использовать многоядерные процессоры и большие объемы памяти.

Минимальное количество серверов Controlplane в инсталляции — 3; добавление происходит кратно 3.

В больших инсталляциях возможно дальнейшие разделение ролей и выделение следующих узлов:

* Network узлы, обеспечивающие работу SDN.
* Узлы K8s для служебного кластера Kubernetes, в котором работает часть сервисов Controlplane.
* Отдельные узлы для служебной СУБД.

При подготовке проекта рекомендуется исходить из следующей конфигурации:

* 2x Intel Xeon Gold 5218
* 512 Гбайт ОЗУ
* 4x 480 Гбайт NVMe
* 4х25Gb или 4x10Gb (2x LACP)

## {heading(Compute)[id=server_requirement_compute]}

Серверы этой группы непосредственно несут полезную нагрузку — на них выполняются ВМ и PaaS-сервисы. Рекомендованные конфигурации отличаются высокой вариативностью в зависимости от требований заказчика. Возможно применение различных конфигураций в рамках роли с объединением одинаковых серверов в агрегаты гипервизоров.

Общая рекомендация: использовать процессоры с максимальным количеством ядер при заданной частоте. Объем памяти зависит от требований к сайзингу и допустимых коэффициентов переподписки (см. {linkto(../../sizing/sizing_roles#sizing_roles)[text=%text]}).

Минимальное количество серверов Compute в инсталляции — 1; добавление можно производить по одному серверу.

Базовый вариант конфигурации сервера Compute:

* 2x Intel Xeon Gold 6238R
* 1024 Гбайт ОЗУ
* 2x480 Гбайт SSD
* 2х25Gb или 4x10Gb (2x LACP)

## {heading(Monitoring/Logging)[id=server_requirement_monitoring_logging]}

На серверах группы Monitoring/Logging размещаются сервисы мониторинга и логирования:

* Мониторинг реализован на базе Zabbix с использованием MySQL для хранения данных.
* Логирование реализовано на связке OpenSearch/OpenSearch Dashboard c Logstash, Kafka и Filebeat.

Особенностью серверов этой роли является высокая зависимость нагрузки от объема и состава платформы.

Для размещения этой роли допустимо использовать виртуальные машины.

По умолчанию рекомендуется закладывать один сервер. При большом размере инсталляции или при интеграции хранилища VK S3 может потребоваться увеличение числа серверов (см. {linkto(../../sizing/sizing_roles#sizing_roles)[text=%text]}).

Базовая конфигурация:

* 2x Intel Xeon Silver 4210R
* 128 Гбайт ОЗУ
* 2x3.84 Тбайт SSD
* 2x10Gb (LACP)

## {heading(RS)[id=server_requirement_rs]}

Серверы этой группы выполняют функции BGP Route Reflector для обеспечения работы и отказоустойчивости веб-портала, внешних и внутренних эндпойнтов и сервисов в служебном кластере Kubernetes.

<warn>

Данная роль опциональна — возможно использование функционала сетевого оборудования заказчика.

</warn>

RS и Controlplane узлы должны находиться в одной автономной системе (AS) и иметь `iBGP` соседство. Между RS узлами и пограничными BGP маршрутизаторами сети заказчика устанавливается `eBGP` соседство таким образом, чтобы Next-Hop префиксов передаваемых от RS к пограничным маршрутизаторам не изменялся (опция Next-Hop unchanged).

Если есть техническая возможность установить `iBGP` соседство между ControlPlane узлами и BGP RR заказчика, то серверы RS можно исключить из схемы анонсов префиксов веб-портала, внешних и внутренних эндпойнтов и сервисов в служебном кластере Kubernetes.

Для production инсталляций всегда требуется два сервера. Для тестовых контуров допустимо использовать один сервер или виртуальную машину.

Базовая конфигурация:

* Intel Xeon E3-1230v6
* 8 (16) Гбайт ОЗУ
* 2x240 Гбайт SSD
* 2x10Gb (LACP)

## {heading(Deploy)[id=server_requirement_deploy]}

Эта группа представлена единственным сервером и используется начиная с самых начальных этапов развертывания платформы. В отличии от остальных, этот сервер должен предоставляться заказчиком с уже установленной ОС.

Основные задачи Deploy-сервера:

* С него выполняется запуск механизмов развертывания платформы.
* Он используется для изменения настроек, обновления и восстановления платформы.
* С его помощью производится подготовка новых гипервизоров к вводу в работу.
* Он используется для размещения сервиса репозитория пакетов и образов компонентов облачной платформы. Помимо них, в нем размещаются и docker-образы части PaaS-сервисов.

<err>

Крайне важно, чтобы Deploy-сервер не был отключен после развертывания платформы, а был постоянно доступен для функционирования PaaS-сервисов, которые в своей работе используют репозитории Nexus.

</err>

Высоких требований к конфигурации и отказоустойчивости сервера не предъявляется. Требуется только один сервер, допустимо дублирование роли. В любом случае необходимо выполнять регулярное резервное копирование узла и периодически проверять корректность его восстановления.

Для размещения этой роли допустимо использовать виртуальные машины.

Крайне не рекомендуется, но допустимо объединять узел Deploy с узлом мониторинга в малых инсталляциях.

Базовая конфигурация:

* Intel Xeon E3-1230v6
* 8 (16) Гбайт ОЗУ
* 2x960 Гбайт SSD
* 1x10Gb
